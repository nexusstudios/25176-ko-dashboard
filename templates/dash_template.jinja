<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{page_title}}</title>
    <link rel="icon" type="image/x-icon" href="img/favicon.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css?v=2.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        setTimeout(function(){
            window.location.reload();
        }, 60000);
    </script>
</head>
<body>
<div class="container">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <h1><i class="fa-solid fa-chart-line"></i> {{page_title}}</h1>
        <p>Comprehensive GitHub Actions Workflow Monitoring</p>
    </div>

    <!-- Summary Statistics -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-card-icon success">
                    <i class="fa-solid fa-circle-check"></i>
                </div>
                <div class="stat-card-content">
                    <h3>Passing Workflows</h3>
                </div>
            </div>
            <div class="stat-card-value success" id="passing-count">{{stats.passing_count}}</div>
            <div class="stat-card-footer">
                {{stats.passing_percent}}% of total workflows
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-card-icon danger">
                    <i class="fa-solid fa-circle-xmark"></i>
                </div>
                <div class="stat-card-content">
                    <h3>Failing Workflows</h3>
                </div>
            </div>
            <div class="stat-card-value danger" id="failing-count">{{stats.failing_count}}</div>
            <div class="stat-card-footer">
                {{stats.failing_percent}}% require attention
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-card-icon warning">
                    <i class="fa-solid fa-clock"></i>
                </div>
                <div class="stat-card-content">
                    <h3>Stale Workflows</h3>
                </div>
            </div>
            <div class="stat-card-value warning" id="stale-count">{{stats.stale_count}}</div>
            <div class="stat-card-footer">
                Not run recently
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-card-icon info">
                    <i class="fa-brands fa-github"></i>
                </div>
                <div class="stat-card-content">
                    <h3>Total Repositories</h3>
                </div>
            </div>
            <div class="stat-card-value info" id="repo-count">{{stats.repo_count}}</div>
            <div class="stat-card-footer">
                Being monitored
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-section">
        <div class="charts-grid">
            <div class="chart-card">
                <h3><i class="fa-solid fa-chart-pie"></i> Workflow Status Distribution</h3>
                <div class="chart-container">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3><i class="fa-solid fa-chart-bar"></i> Status by Repository</h3>
                <div class="chart-container">
                    <canvas id="repoChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Table -->
    <div class="table-container">
        <h2><i class="fa-solid fa-table"></i> Repository Details</h2>
        <table>
        <tr>
            <th colspan="1" scope="colgroup" style="width:150px">Repository</th>
            <th colspan="1" scope="colgroup" style="width:50px">Copier<br>Version</th>
            {%- if contains_smoke %}
            <th colspan="3" scope="colgroup">Nightly Test</th>
            {%- endif %}
            {%- if contains_bench %}
            <th colspan="3" scope="colgroup">Nightly<br>Benchmarks</th>
            {%- endif %}
            {%- if contains_docs %}
            <th colspan="3" scope="colgroup">Build Docs</th>
            {%- endif %}
            {%- if contains_live %}
            <th colspan="3" scope="colgroup">Live Build</th>
            {%- endif %}
            {%- if contains_other %}
            <th colspan="1" scope="colgroup">Other Workflows</th>
            {%- endif %}
        </tr>
    </tr>

    {% for project in all_projects %}
    <tr>
        <td><a href="{{project.repo_url}}">{{project.repo}}</a></td>
        <td class="{{project.copier_version_display_class}}">{{project.copier_version}}</td>

        {%- if contains_smoke %}
        <!-- Smoke Test -->
        <td class="{{project.smoke_test.display_class}} align-right">
            {%- if project.smoke_test.is_stale %}
            <span class="gray-cell">stale</span><br/>
            {%- endif %}
            {{project.smoke_test.workflow_status}}
        </td>
        <td class="{{project.smoke_test.display_class}} align-center">
            {%- if project.smoke_test.is_stale %}
            <i class="gray-cell fa-solid fa-clock"></i><br/>
            {%- endif %}
            <i class="{{project.smoke_test.icon_class}}"></i>
        </td>
        <td class="{{project.smoke_test.display_class}}">
            <a href="{{project.smoke_test.workflow_url}}">
                {{project.smoke_test.conclusion_time}}
            </a>
        </td>
        {%- endif %}

        {%- if contains_bench %}
        <!-- Benchmarks -->
        <td class="{{project.benchmarks.display_class}} align-right">
            {%- if project.benchmarks.is_stale %}
            <span class="gray-cell">stale</span><br/>
            {%- endif %}
            {{project.benchmarks.workflow_status}}
        </td>
        <td class="{{project.benchmarks.display_class}} align-center">
            {%- if project.benchmarks.is_stale %}
            <i class="gray-cell fa-solid fa-clock"></i><br/>
            {%- endif %}
            <i class="{{project.benchmarks.icon_class}}"></i>
        </td>
        <td class="{{project.benchmarks.display_class}}">
            <a href="{{project.benchmarks.workflow_url}}">
                {{project.benchmarks.conclusion_time}}
            </a>
        </td>
        {%- endif %}

        {%- if contains_docs %}
        <!-- Build Docs (don't worry about is_stale here) -->
        <td class="{{project.build_docs.display_class}} align-right">
            {{project.build_docs.workflow_status}}
        </td>
        <td class="{{project.build_docs.display_class}} align-center">
            <i class="{{project.build_docs.icon_class}}"></i>
        </td>
        <td class="{{project.build_docs.display_class}}">
            <a href="{{project.build_docs.workflow_url}}">
                {{project.build_docs.conclusion_time}}
            </a>
        </td>
        {%- endif %}

        {%- if contains_live %}
        <!-- Live Build -->
        <td class="{{project.live_build.display_class}} align-right">
            {%- if project.live_build.is_stale %}
            <span class="gray-cell">stale</span><br/>
            {%- endif %}
            {{project.live_build.workflow_status}}
        </td>
        <td class="{{project.live_build.display_class}} align-center">
            {%- if project.live_build.is_stale %}
            <i class="gray-cell fa-solid fa-clock"></i><br/>
            {%- endif %}
            <i class="{{project.live_build.icon_class}}"></i>
        </td>
        <td class="{{project.live_build.display_class}}">
            <a href="{{project.live_build.workflow_url}}">
                {{project.live_build.conclusion_time}}
            </a>
        </td>
        {%- endif %}
        
        {%- if contains_other %}
        <!-- Other -->
        <td>
            {% for workflow in project.other_workflows %}
                <a href="{{workflow.workflow_url}}">{{workflow.friendly_name}}</a>
                <br/>
                <div class="{{workflow.display_class}} inline">{{workflow.workflow_status}} <i class="{{workflow.icon_class}}"></i></div>
                <div class="inline"><a href="{{workflow.workflow_url}}">{{workflow.conclusion_time_one_line}}</a></div>
                <br/>
            </a>
            {% endfor %}
        </td>
        {%- endif %}
    </tr>
    {% endfor %}
    </table>
    </div>

    <!-- Footer -->
    <div class="footer">
        <p>
            <i class="fa-solid fa-clock"></i> Last Updated {{last_updated}} | 
            <a href='https://github.com/lincc-frameworks/{{dash_repo}}'><i class="fa-brands fa-github"></i> {{dash_repo}}</a>
            {% for link in extra_links %}
            | <a href='{{link.url}}'><i class="fa-brands fa-github"></i> {{link.text}}</a>
            {% endfor %}
        </p>
    </div>
</div>

<!-- Chart.js Configuration -->
<script>
    // Status Distribution Pie Chart
    const statusCtx = document.getElementById('statusChart');
    new Chart(statusCtx, {
        type: 'doughnut',
        data: {
            labels: ['Passing', 'Failing', 'Stale', 'Pending'],
            datasets: [{
                data: [
                    {{stats.passing_count}}, 
                    {{stats.failing_count}}, 
                    {{stats.stale_count}}, 
                    {{stats.pending_count}}
                ],
                backgroundColor: [
                    'rgba(72, 187, 120, 0.9)',
                    'rgba(252, 129, 129, 0.9)',
                    'rgba(246, 173, 85, 0.9)',
                    'rgba(99, 179, 237, 0.9)'
                ],
                borderColor: [
                    '#48bb78',
                    '#fc8181',
                    '#f6ad55',
                    '#63b3ed'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#f7fafc',
                        padding: 20,
                        font: {
                            size: 14,
                            weight: '600'
                        }
                    }
                },
                tooltip: {
                    backgroundColor: '#1e2736',
                    titleColor: '#f7fafc',
                    bodyColor: '#cbd5e0',
                    borderColor: '#4a5568',
                    borderWidth: 1,
                    padding: 15,
                    displayColors: true,
                    titleFont: {
                        size: 14,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 13
                    }
                }
            }
        }
    });

    // Repository Status Bar Chart
    const repoCtx = document.getElementById('repoChart');
    new Chart(repoCtx, {
        type: 'bar',
        data: {
            labels: [
                {%- for project in all_projects %}
                '{{project.repo}}'{% if not loop.last %},{% endif %}
                {%- endfor %}
            ],
            datasets: [
                {
                    label: 'Passing',
                    data: [
                        {%- for project in all_projects %}
                        {{project.passing_workflows}}{% if not loop.last %},{% endif %}
                        {%- endfor %}
                    ],
                    backgroundColor: 'rgba(72, 187, 120, 0.9)',
                    borderColor: '#48bb78',
                    borderWidth: 0
                },
                {
                    label: 'Failing',
                    data: [
                        {%- for project in all_projects %}
                        {{project.failing_workflows}}{% if not loop.last %},{% endif %}
                        {%- endfor %}
                    ],
                    backgroundColor: 'rgba(252, 129, 129, 0.9)',
                    borderColor: '#fc8181',
                    borderWidth: 0
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    stacked: true,
                    ticks: {
                        color: '#cbd5e0',
                        maxRotation: 45,
                        minRotation: 45,
                        font: {
                            size: 12,
                            weight: '600'
                        }
                    },
                    grid: {
                        color: '#2d3748',
                        borderColor: '#4a5568'
                    }
                },
                y: {
                    stacked: true,
                    ticks: {
                        color: '#cbd5e0',
                        stepSize: 1,
                        font: {
                            size: 12,
                            weight: '600'
                        }
                    },
                    grid: {
                        color: '#2d3748',
                        borderColor: '#4a5568'
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#f7fafc',
                        padding: 20,
                        font: {
                            size: 14,
                            weight: '600'
                        }
                    }
                },
                tooltip: {
                    backgroundColor: '#1e2736',
                    titleColor: '#f7fafc',
                    bodyColor: '#cbd5e0',
                    borderColor: '#4a5568',
                    borderWidth: 1,
                    padding: 15,
                    titleFont: {
                        size: 14,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 13
                    }
                }
            }
        }
    });
</script>

</body>
</html>